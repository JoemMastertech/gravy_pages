const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/OnboardingModal-Bsr542a7.js","assets/index-DsW3iqv0.js","assets/index-SV0FPQTz.css"])))=>i.map(i=>d[i]);
import{s as l,L as r,_ as u}from"./index-DsW3iqv0.js";class h{constructor(){this.client=l,this.user=null,this.session=null,this.profile=null,this._listeners=[],this._init(),typeof window<"u"&&(window.AuthService=this)}async _init(){try{const{data:{session:e}}=await this.client.auth.getSession();e?.user&&(this.session=e,this.user=e.user,await this._loadProfile(this.user.id)),this.client.auth.onAuthStateChange(async(t,i)=>{r.info(`AuthService: Auth State Changed -> ${t}`),t==="SIGNED_IN"||t==="TOKEN_REFRESHED"?(this.session=i,this.user=i?.user||null,await this._loadProfile(this.user?.id)):t==="SIGNED_OUT"&&(this.user=null,this.profile=null,this._notifyListeners())})}catch(e){r.error("AuthService: Init Failed",e)}}async _loadProfile(e){if(e)try{const{data:t,error:i}=await this.client.from("profiles").select("*").eq("id",e).single();if(i)if(i.code==="PGRST116")r.warn("AuthService: Profile not found for user",e);else throw i;this.profile=t||null,r.info("AuthService: Profile Loaded",this.profile);const s=sessionStorage.getItem("SAT_REGISTRATION_MODE")==="true";if(this.profile&&!this.profile.restaurant_id){r.info("AuthService: User needs onboarding. Launching modal...");const{default:o}=await u(async()=>{const{default:a}=await import("./OnboardingModal-Bsr542a7.js");return{default:a}},__vite__mapDeps([0,1,2]));o.show()}this.profile?.restaurant_id&&sessionStorage.removeItem("SAT_REGISTRATION_MODE"),this._notifyListeners()}catch(t){r.error("AuthService: Load Profile Failed",t)}}async loginWithGoogle(){try{const{data:e,error:t}=await this.client.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin}});if(t)throw t;return e}catch(e){throw r.error("AuthService: Google Login Failed",e),e}}setRegistrationMode(e){e?sessionStorage.setItem("SAT_REGISTRATION_MODE","true"):sessionStorage.removeItem("SAT_REGISTRATION_MODE")}async createRestaurant({name:e,owner:t,currency:i}){try{const s=this.user;if(!s)throw new Error("Usuario no autenticado");const{data:o,error:a}=await this.client.from("perfil_restaurante").insert([{nombre:e,configuracion_json:{moneda:i,propietario:t,tema:"default",orden_categorias:[]},usuario_admin_id:s.id}]).select().single();if(a)throw a;const{error:n}=await this.client.from("profiles").update({restaurant_id:o.id}).eq("id",s.id);if(n)throw n;return r.info("AuthService: Restaurant Created!",o),await this._loadProfile(s.id),!0}catch(s){throw r.error("AuthService: Create Restaurant Failed",s),s}}async loginWithEmail(e){try{const{data:t,error:i}=await this.client.auth.signInWithOtp({email:e,options:{emailRedirectTo:window.location.origin}});if(i)throw i;return t}catch(t){throw r.error("AuthService: Email Login Failed",t),t}}async logout(){console.log("[AuthService] Logout initiated...");try{const e=new Promise((t,i)=>setTimeout(()=>i(new Error("Logout timed out")),2e3));await Promise.race([this.client.auth.signOut(),e]),console.log("[AuthService] Signed out successfully from Supabase")}catch(e){console.error("[AuthService] Logout Warning (proceeding anyway):",e)}finally{console.log("[AuthService] Forcing local state cleanup and reload..."),this.user=null,this.profile=null,sessionStorage.clear(),this._notifyListeners();try{localStorage.removeItem("sb-udtlqjmrtbcpdqknwuro-auth-token")}catch(e){console.warn("Could not clear localStorage",e)}window.location.reload()}}getRestaurantId(){return this.profile?.restaurant_id||null}isMasterAdmin(){return!this.user||!this.profile?!1:["joerl@mastertech.mx","joerlyzquierdo@gmail.com"].includes(this.user.email)?!0:this.profile.is_master===!0||this.profile.role==="master"}canEdit(){return this.isMasterAdmin()||!!this.getRestaurantId()}subscribe(e){return this._listeners.push(e),e(this.user,this.profile),()=>this._listeners=this._listeners.filter(t=>t!==e)}_notifyListeners(){this._listeners.forEach(e=>e(this.user,this.profile))}}const f=new h;export{f as default};
